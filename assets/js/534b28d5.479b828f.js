"use strict";(self.webpackChunkneon_docs=self.webpackChunkneon_docs||[]).push([[3550],{6447:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>c,contentTitle:()=>l,default:()=>u,frontMatter:()=>t,metadata:()=>i,toc:()=>a});var o=n(4848),s=n(8453);n(4182),n(1801),n(3012),n(7227),n(9489);const t={sidebar_position:3,displayed_sidebar:"operatorsdk",title:"Controllers",hide_title:!1,hide_table_of_contents:!1,description:"Resource Controllers are responsible for reconciling resources",keywords:["operator","sdk","crd","crds","custom resource","resource controller"],last_update:{author:"NeonFORGE Team"}},l="Resource Controllers",i={id:"operator-sdk/controllers",title:"Controllers",description:"Resource Controllers are responsible for reconciling resources",source:"@site/docs/operator-sdk/controllers.mdx",sourceDirName:"operator-sdk",slug:"/operator-sdk/controllers",permalink:"/docs/operator-sdk/controllers",draft:!1,unlisted:!1,editUrl:"https://github.com/nforgeio/documentation/edit/master/docs/operator-sdk/controllers.mdx",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3,displayed_sidebar:"operatorsdk",title:"Controllers",hide_title:!1,hide_table_of_contents:!1,description:"Resource Controllers are responsible for reconciling resources",keywords:["operator","sdk","crd","crds","custom resource","resource controller"],last_update:{author:"NeonFORGE Team"}},sidebar:"operatorsdk",previous:{title:"Getting Started",permalink:"/docs/operator-sdk/getting-started"},next:{title:"Webhooks",permalink:"/docs/category/webhooks"}},c={},a=[{value:"Introduction",id:"introduction",level:2},{value:"Reconciler",id:"reconciler",level:2},{value:"Triggers",id:"triggers",level:3},{value:"Example",id:"example",level:3},{value:"Status Updates",id:"status-updates",level:2},{value:"Requeuing",id:"requeuing",level:2},{value:"Global defaults",id:"global-defaults",level:3},{value:"Controller specific",id:"controller-specific",level:3},{value:"Manual requeue",id:"manual-requeue",level:3},{value:"Leader election",id:"leader-election",level:2},{value:"Events",id:"events",level:3},{value:"Configuring",id:"configuring",level:3},{value:"Filtering",id:"filtering",level:2},{value:"Field Selectors",id:"field-selectors",level:3},{value:"Label Selectors",id:"label-selectors",level:3},{value:"Dependent Resources",id:"dependent-resources",level:2}];function d(e){const r={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",mdxAdmonitionTitle:"mdxAdmonitionTitle",mermaid:"mermaid",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(r.h1,{id:"resource-controllers",children:"Resource Controllers"}),"\n",(0,o.jsx)(r.h2,{id:"introduction",children:"Introduction"}),"\n",(0,o.jsx)(r.p,{children:"Resource Controllers are called when Kubernetes resources are created, modified,\r\nor deleted. They are configured to watch specific resource types, have methods\r\nfor responding to such updates."}),"\n",(0,o.jsx)(r.mermaid,{value:"flowchart TD\r\n    A[User] -- kubectl apply resource.yaml --\x3e K{Kubernetes API}\r\n    C[ResourceManager] -- watch resources --\x3e K\r\n    C -- schedule resource --\x3e R[Reconciler]\r\n    R -- result --\x3e C\r\n    R -- update state --\x3e K"}),"\n",(0,o.jsx)(r.h2,{id:"reconciler",children:"Reconciler"}),"\n",(0,o.jsx)(r.p,{children:"Reconcilers are responsible for bringing the actual state of a resource to the\r\ndesired state, which is expressed in the Custom Resource object specification."}),"\n",(0,o.jsx)(r.p,{children:"When a reconcile event is triggered, it is always passed the current state of\r\nthe resource to be reconciled."}),"\n",(0,o.jsxs)(r.admonition,{type:"danger",children:[(0,o.jsx)(r.mdxAdmonitionTitle,{}),(0,o.jsxs)(r.p,{children:["A reconciler must be\r\n",(0,o.jsx)(r.a,{href:"https://en.wikipedia.org/wiki/Idempotence",children:"idempotent"})]}),(0,o.jsx)(r.p,{children:"A function is said to be idempotent if it can be applied multiple times without\r\nchanging the result beyond the initial application."})]}),"\n",(0,o.jsx)(r.h3,{id:"triggers",children:"Triggers"}),"\n",(0,o.jsx)(r.p,{children:"Reconcile is triggered by the following events:"}),"\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsx)(r.li,{children:"A resource has been created."}),"\n",(0,o.jsx)(r.li,{children:"A resource has been updated."}),"\n",(0,o.jsx)(r.li,{children:"A resource failed reconciliation and was requeued."}),"\n",(0,o.jsxs)(r.li,{children:["An object with an\r\n",(0,o.jsx)(r.a,{href:"https://kubernetes.io/docs/concepts/overview/working-with-objects/owners-dependents/#owner-references-in-object-specifications",children:(0,o.jsx)(r.code,{children:"ownerReference"})}),"\r\nto the resource."]}),"\n"]}),"\n",(0,o.jsx)(r.h3,{id:"example",children:"Example"}),"\n",(0,o.jsxs)(r.p,{children:["In its simplest form, this is what the ",(0,o.jsx)(r.code,{children:"ReconcileAsync"})," method looks like:"]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-csharp",children:"using Neon.Operator;\r\nusing Neon.Operator.Controllers;\r\n\r\npublic class ExampleController : ResourceControllerBase<V1ExampleEntity>\r\n{\r\n    public override async Task<ResourceControllerResult> ReconcileAsync(V1ExampleEntity resource)\r\n    {\r\n        // TODO: apply logic\r\n\r\n        return ResourceControllerResult.Ok();\r\n    }\r\n}\n"})}),"\n",(0,o.jsx)(r.h2,{id:"status-updates",children:"Status Updates"}),"\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.code,{children:"StatusModifiedAsync"})," is called when the status of a resource has changed."]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-csharp",children:"public override async Task StatusModifiedAsync(V1ExampleEntity resource)\r\n{\r\n    // react to status update\r\n}\n"})}),"\n",(0,o.jsx)(r.h2,{id:"requeuing",children:"Requeuing"}),"\n",(0,o.jsx)(r.p,{children:"When a reconcile event throws an exception, it will be requeued."}),"\n",(0,o.jsx)(r.h3,{id:"global-defaults",children:"Global defaults"}),"\n",(0,o.jsxs)(r.p,{children:["Global defaults can be configured by setting ",(0,o.jsx)(r.code,{children:"ResourceManagerOptions"})," in\r\n",(0,o.jsx)(r.code,{children:"ConfigureOperator"}),"."]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-csharp",children:"var k8s = KubernetesOperatorHost\r\n            .CreateDefaultBuilder()\r\n            .ConfigureOperator(configure =>\r\n            {\r\n                configure.ResourceManagerOptions = new ResourceManagerOptions()\r\n                {\r\n                    ErrorMaxRequeueInterval = TimeSpan.FromMinutes(1),\r\n                    ErrorMaxRetryCount      = 10,\r\n                    ErrorMinRequeueInterval = TimeSpan.FromSeconds(1)\r\n                };\r\n            })\r\n            .UseStartup<Startup>()\r\n            .Build();\r\n\r\nawait = k8s.RunAsync();\n"})}),"\n",(0,o.jsx)(r.h3,{id:"controller-specific",children:"Controller specific"}),"\n",(0,o.jsxs)(r.p,{children:["Controllers are configurable by passing ",(0,o.jsx)(r.code,{children:"ResourceManagerOptions"})," to your\r\ncontroller when calling ",(0,o.jsx)(r.code,{children:"AddController"})," in ",(0,o.jsx)(r.code,{children:"Startup.cs"}),"."]}),"\n",(0,o.jsx)(r.admonition,{type:"note",children:(0,o.jsxs)(r.p,{children:["To do this manual configuration, automatic configuration should be disabled by\r\nadding the ",(0,o.jsx)(r.code,{children:"[Controller(Ignore = true)]"})," attribute to the controller."]})}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-csharp",children:"using Neon.Operator;\r\nusing Neon.Operator.ResourceManager;\r\n\r\npublic void ConfigureServices(IServiceCollection services)\r\n{\r\n    services.AddKubernetesOperator()\r\n            .AddController<ExampleController>(\r\n            options: new ResourceManagerOptions()\r\n            {\r\n                ErrorMaxRequeueInterval = TimeSpan.FromMinutes(1),\r\n                ErrorMaxRetryCount      = 10,\r\n                ErrorMinRequeueInterval = TimeSpan.FromSeconds(1)\r\n            });\r\n}\n"})}),"\n",(0,o.jsx)(r.h3,{id:"manual-requeue",children:"Manual requeue"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-csharp",children:"public override async Task<ResourceControllerResult> ReconcileAsync(V1ExampleEntity resource)\r\n{\r\n    return ResourceControllerResult.RequeueEvent(TimeSpan.FromSeconds(10));\r\n}\n"})}),"\n",(0,o.jsx)(r.h2,{id:"leader-election",children:"Leader election"}),"\n",(0,o.jsx)(r.h3,{id:"events",children:"Events"}),"\n",(0,o.jsx)(r.p,{children:"The following methods are provided for reacting to leadership events."}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-csharp",children:"public override async Task OnPromotionAsync()\r\n{\r\n    // Controller was promoted to leader.\r\n}\r\n\r\npublic override async Task OnDemotionAsync()\r\n{\r\n    // Controller is no longer leader.\r\n}\r\n\r\npublic override async Task OnNewLeaderAsyncc(string identity)\r\n{\r\n    // There is a new leader. The identity of the new leader is given.\r\n}\n"})}),"\n",(0,o.jsx)(r.h3,{id:"configuring",children:"Configuring"}),"\n",(0,o.jsxs)(r.p,{children:["Leader election can be configured by setting ",(0,o.jsx)(r.code,{children:"LeaderElectionConfig"})," when adding\r\na controller via ",(0,o.jsx)(r.code,{children:"AddController"})," in ",(0,o.jsx)(r.code,{children:"Startup.cs"}),"."]}),"\n",(0,o.jsx)(r.admonition,{type:"note",children:(0,o.jsxs)(r.p,{children:["To do this manual configuration, automatic configuration should be disabled by\r\nadding the ",(0,o.jsx)(r.code,{children:"[Controller(Ignore = true)]"})," attribute to the controller."]})}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-csharp",children:'using Neon.Operator;\r\n\r\npublic void ConfigureServices(IServiceCollection services)\r\n{\r\n    services.AddKubernetesOperator()\r\n            .AddController<ExampleController>(\r\n                leaderConfig: new LeaderElectionConfig(\r\n                    k8s:           K8s,\r\n                    @namespace:    "default",\r\n                    leaseName:     $"example.controller",\r\n                    identity:      Pod.Name))\r\n}\n'})}),"\n",(0,o.jsx)(r.h2,{id:"filtering",children:"Filtering"}),"\n",(0,o.jsxs)(r.p,{children:["Filtering resources can be achieved by applying\r\n",(0,o.jsx)(r.a,{href:"https://kubernetes.io/docs/concepts/overview/working-with-objects/field-selectors/",children:"field selectors"}),"\r\nand/or\r\n",(0,o.jsx)(r.a,{href:"https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/",children:"label selectors"}),".\r\nBoth label selectors and field selectors are comma-separated ",(0,o.jsx)(r.code,{children:"key=value"}),"\r\nstrings."]}),"\n",(0,o.jsx)(r.h3,{id:"field-selectors",children:"Field Selectors"}),"\n",(0,o.jsxs)(r.p,{children:["Field selectors can be set either by the ",(0,o.jsx)(r.code,{children:"Controller"})," attribute, or by the\r\n",(0,o.jsx)(r.code,{children:"ResourceManagerOptions.FieldSelector"})," property."]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-csharp",children:'[Controller(FieldSelector = "metadata.name=my-resource")]\r\npublic class ExampleController : ResourceControllerBase<ExampleResource>\r\n\n'})}),"\n",(0,o.jsx)(r.h3,{id:"label-selectors",children:"Label Selectors"}),"\n",(0,o.jsxs)(r.p,{children:["Field selectors can be set either by the ",(0,o.jsx)(r.code,{children:"Controller"})," attribute, or by the\r\n",(0,o.jsx)(r.code,{children:"ResourceManagerOptions.FieldSelector"})," property."]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-csharp",children:'[Controller(LabelSelector = "neonkube.io/managed-by=my-operator,neonkube.io/controlled-by=example-controller")]\r\npublic class ExampleController : ResourceControllerBase<ExampleResource>\r\n\n'})}),"\n",(0,o.jsx)(r.h2,{id:"dependent-resources",children:"Dependent Resources"}),"\n",(0,o.jsxs)(r.p,{children:["In many cases, an operator creates a bunch of Kubernetes resources in the\r\ncluster, as a result of reconciling a ",(0,o.jsx)(r.code,{children:"Resource"}),". For instance, the\r\netcd-operator creates two services and a number of pods for a single EtcdCluster\r\nCR. In this case, all the Kubernetes resources created by the operator for a CR\r\nis defined as dependent resources. The etcd-operator may want to watch the pods\r\nthat it created in case it needs to reconcile again."]}),"\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.code,{children:"DependentResources"})," can be defined by adding an annotation to the ",(0,o.jsx)(r.code,{children:"Controller"}),"."]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-csharp",children:"using Neon.Operator;\r\nusing Neon.Operator.Controllers;\r\n\r\n[DependentResource<V1Pod>]\r\n[DependentResource<V1Service>]\r\npublic class EtcdController : ResourceControllerBase<V1EtcdCluster>\r\n{\r\n   // Controller implementation.\r\n}\n"})}),"\n",(0,o.jsxs)(r.p,{children:["Controllers are configurable by setting ",(0,o.jsx)(r.code,{children:"DependentResources"})," in\r\n",(0,o.jsx)(r.code,{children:"ResourceManagerOptions"})," when adding a controller via ",(0,o.jsx)(r.code,{children:"AddController"})," in\r\n",(0,o.jsx)(r.code,{children:"Startup.cs"}),"."]}),"\n",(0,o.jsx)(r.admonition,{type:"note",children:(0,o.jsxs)(r.p,{children:["To do this manual configuration, automatic configuration should be disabled by\r\nadding the ",(0,o.jsx)(r.code,{children:"[Controller(Ignore = true)]"})," attribute to the controller."]})}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-csharp",children:"using Neon.Operator;\r\nusing Neon.Operator.ResourceManager;\r\n\r\npublic void ConfigureServices(IServiceCollection services)\r\n{\r\n    services.AddKubernetesOperator()\r\n        .AddController<EtcdController>(\r\n            options: new ResourceManagerOptions()\r\n            {\r\n                DependentResources = new List<IDependentResource>()\r\n                {\r\n                    new DependentResource<V1Pod>(),\r\n                    new DependentResource<V1Service>()\r\n                }\r\n            });\r\n}\r\n\n"})})]})}function u(e={}){const{wrapper:r}={...(0,s.R)(),...e.components};return r?(0,o.jsx)(r,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}}}]);